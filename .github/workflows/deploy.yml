name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  NODE_VERSION: '20.x'

jobs:
  build-and-test:
    name: Build e Testes
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        dotnet-quality: 'preview'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Restore dependências .NET
      run: dotnet restore src/ControlFinance.Api/ControlFinance.Api.csproj

    - name: Build .NET
      run: dotnet build src/ControlFinance.Api/ControlFinance.Api.csproj --configuration Release --no-restore

    - name: Instalar dependências Next.js
      working-directory: ./web-next
      run: npm ci

    - name: Build Next.js
      working-directory: ./web-next
      run: npm run build

    - name: Executar testes .NET
      run: dotnet test --no-build --verbosity normal || echo "Sem testes configurados ainda"

  deploy:
    name: Deploy para Produção
    needs: build-and-test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Extrair versão da tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Adicionar host conhecido
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Copiar arquivos para servidor
      run: |
        rsync -avz --delete \
          --exclude '.git' \
          --exclude 'bin' \
          --exclude 'obj' \
          --exclude 'node_modules' \
          --exclude '.next' \
          --exclude '.env' \
          ./ ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:~/controlfinance/

    - name: Deploy com Docker Compose
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd ~/controlfinance
          
          echo "=== Deploy ${{ steps.version.outputs.VERSION }} ==="
          
          # Build novos containers
          docker compose -f docker-compose.prod.yml build --no-cache
          
          # Parar containers antigos e iniciar novos
          docker compose -f docker-compose.prod.yml down
          docker compose -f docker-compose.prod.yml up -d
          
          # Limpar imagens não utilizadas
          docker image prune -f
          
          # Verificar status
          echo "=== Status dos containers ==="
          docker compose -f docker-compose.prod.yml ps
        EOF

    - name: Aguardar inicialização
      run: sleep 40

    - name: Verificar saúde da API
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "curl -sf http://localhost:5000/api/telegram/health || exit 1"
        echo "API está respondendo!"

    - name: Verificar saúde do Frontend
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "curl -sf -o /dev/null http://localhost:3000 || exit 1"
        echo "Frontend está respondendo!"

    - name: Resumo do deploy
      if: success()
      run: |
        echo "## Deploy concluído com sucesso! ✅" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Versão:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **API:** https://api.nicolasportie.com" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend:** https://finance.nicolasportie.com" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
