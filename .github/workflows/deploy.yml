name: CI/CD Pipeline

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  NODE_VERSION: '20.x'

jobs:
  build-and-test:
    name: Build e Testes
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        dotnet-quality: 'preview'
        cache: true
        cache-dependency-path: '**/*.csproj'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: './web-next/package-lock.json'

    - name: Restore dependências .NET
      run: dotnet restore src/ControlFinance.Api/ControlFinance.Api.csproj

    - name: Build .NET
      run: dotnet build src/ControlFinance.Api/ControlFinance.Api.csproj --configuration Release --no-restore

    - name: Instalar dependências Next.js
      working-directory: ./web-next
      run: npm ci

    - name: Build Next.js
      working-directory: ./web-next
      run: npm run build

    - name: Executar testes .NET
      run: dotnet test --no-build --verbosity normal || echo "Sem testes configurados ainda"

  deploy:
    name: Deploy para Produção
    needs: build-and-test
    runs-on: self-hosted
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Extrair versão da tag
      id: version
      run: |
        TAG_VERSION="${GITHUB_REF#refs/tags/}"
        APP_VERSION="${TAG_VERSION#v}"
        echo "TAG_VERSION=${TAG_VERSION}" >> $GITHUB_OUTPUT
        echo "VERSION=${APP_VERSION}" >> $GITHUB_OUTPUT

    - name: Sincronizar arquivos para pasta de deploy
      run: |
        rsync -av --delete \
          --exclude 'bin' \
          --exclude 'obj' \
          --exclude 'node_modules' \
          --exclude '.next' \
          --exclude '.env' \
          ./ ~/controlfinance/

    - name: Deploy com Docker Compose
      env:
        APP_VERSION: ${{ steps.version.outputs.VERSION }}
      run: |
        cd ~/controlfinance
        
        echo "=== Deploy ${APP_VERSION} ==="
        
        # Build novos containers com a versão da tag (permitindo uso de layers do cache do Docker)
        APP_VERSION=${APP_VERSION} docker compose -f docker-compose.prod.yml build --build-arg VERSION=${APP_VERSION}
        
        # Parar containers antigos e iniciar novos
        docker compose -f docker-compose.prod.yml down
        APP_VERSION=${APP_VERSION} docker compose -f docker-compose.prod.yml up -d
        
        # Limpar imagens não utilizadas
        docker image prune -f
        
        # Verificar status
        echo "=== Status dos containers ==="
        docker compose -f docker-compose.prod.yml ps

    - name: Aguardar e Verificar saúde da API
      run: |
        echo "Aguardando inicialização da API..."
        for i in {1..30}; do
          if curl -sf http://localhost:5000/health; then
            echo -e "\nAPI está online!"
            exit 0
          fi
          echo -n "."
          sleep 2
        done
        echo -e "\nFalha: API não respondeu após 60 segundos."
        exit 1

    - name: Aguardar e Verificar saúde do Frontend
      run: |
        echo "Aguardando inicialização do Frontend..."
        for i in {1..30}; do
          if curl -sf -o /dev/null http://localhost:3000; then
            echo -e "\nFrontend está online!"
            exit 0
          fi
          echo -n "."
          sleep 2
        done
        echo -e "\nFalha: Frontend não respondeu após 60 segundos."
        exit 1

    - name: Resumo do deploy
      if: success()
      run: |
        echo "## Deploy concluído com sucesso!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Versão:** ${{ steps.version.outputs.TAG_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **API:** https://api.nicolasportie.com" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend:** https://finance.nicolasportie.com" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
